name: Build and Release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# Rozwiązuje błąd 403 Forbidden przy tworzeniu Release
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.0'
          arch: 'win64_mingw'

      - name: Build Application
        shell: bash
        run: |
          mkdir -p build
          cd build
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build .

      - name: Deploy Libraries
        shell: bash
        run: |
          cd build
          # windeployqt zbiera biblioteki Qt
          # flaga --compiler-runtime jest KLUCZOWA, by uniknąć błędów DLL
          windeployqt --no-translations --compiler-runtime --no-opengl-sw Rename_It.exe
          
          # Ręczne kopiowanie krytycznych plików MinGW, których windeployqt czasem nie widzi
          # To one odpowiadają za błąd "Nie znaleziono punktu wejścia procedury"
          cp /bin/libstdc++-6.dll . || true
          cp /bin/libgcc_s_seh-1.dll . || true
          cp /bin/libwinpthread-1.dll . || true
          
          # Kopiujemy tłumaczenia, jeśli istnieją
          if [ -d "../translations" ]; then cp -r ../translations .; fi

      - name: Create Zip
        shell: pwsh
        run: |
          # Pakujemy zawartość folderu build do pliku ZIP
          Compress-Archive -Path build/* -DestinationPath RenameIt_Windows.zip

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: RenameIt_Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
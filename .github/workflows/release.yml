name: Build and Release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.0'
          arch: 'win64_mingw'

      - name: Build Application
        shell: bash
        run: |
          mkdir -p build
          cd build
          
          # Ustawienie ziarna haszowania pomaga w stabilności kompilatora MOC
          export QT_HASH_SEED=0
          
          # Konfiguracja z maksymalnym wyłączeniem problematycznych metatypów
          cmake .. -G "MinGW Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DQT_NO_ASSET_APPENDING=ON \
            -DQT_SKIP_METATYPES_GENERATION=ON \
            -DCMAKE_AUTOGEN_VERBOSE=ON
          
          # Budowanie (bez parametrów równoległych, by uniknąć blokowania plików .json)
          cmake --build .
          
      - name: Deploy Libraries
        shell: bash
        run: |
          cd build
          # Windeployqt przygotowuje wszystkie DLL-ki potrzebne do uruchomienia
          windeployqt --qmldir ../ui --no-translations --compiler-runtime Rename_It.exe
          
          # Kopiowanie folderu tłumaczeń, jeśli istnieje w projekcie
          if [ -d "../translations" ]; then cp -r ../translations .; fi

      - name: Create Zip
        shell: pwsh
        run: |
          # Pakujemy zawartość folderu build do pliku ZIP
          Compress-Archive -Path build/* -DestinationPath RenameIt_Windows.zip

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: RenameIt_Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}